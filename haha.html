<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <audio id="myAudio" src="./jameslan.ogg" controls></audio>
  <div id="dialog-content"></div>
  <script>
    let data; // Khai báo biến data ở phạm vi toàn cục
    let fullText; // Khai báo biến fullText ở phạm vi toàn cục

    const audio = document.getElementById('myAudio');
    const dialogContent = document.getElementById('dialog-content');

    fetch('./jameslan.json')
      .then(response => response.json())
      .then(jsonData => {
        data = jsonData; // Gán dữ liệu JSON vào biến data
        fullText = getFullText(data); // Khởi tạo fullText sau khi fetch dữ liệu
        dialogContent.innerHTML = fullText;


        audio.onplay = function () {
          startTime = Date.now();
          timerInterval = setInterval(updateHighlight, 50);
        };

        audio.onpause = function () {
          clearInterval(timerInterval);
        };

      })
      .catch(error => {
        console.error('Lỗi khi tải JSON:', error);
        dialogContent.textContent = 'Lỗi khi tải đoạn hội thoại.';
      });

    function getFullText(jsonData) {
      let text = "";
      jsonData.dialog.forEach(item => {
        text += item.text;
      });
      return text;
    }


    let startTime = 0;
    let timerInterval;



    function updateHighlight() {
      const currentTime = Date.now() - startTime;

      for (const wordData of data.timestamp) { // Sử dụng for...of để có thể break
        const wordStartTime = wordData[0];
        const wordDuration = wordData[1];
        const wordStartIndex = wordData[3];
        const wordLength = wordData[4];

        if (currentTime >= wordStartTime && currentTime < wordStartTime + wordDuration) {
          const highlightedText = highlightWord(fullText, wordStartIndex, wordLength);
          dialogContent.innerHTML = highlightedText; // Sửa 'text' thành 'dialog-content'
          break; // Dừng vòng lặp sau khi tìm thấy từ cần highlight
        }
      }
    }


    function highlightWord(text, startIndex, length) {
      const before = text.substring(0, startIndex);
      const word = text.substring(startIndex, startIndex + length);
      const after = text.substring(startIndex + length);
      return before + `<span class="highlight">${word}</span>` + after;
    }

  </script>
</body>
<style>
  .highlight {
    background-color: yellow;
  }
</style>

</html>